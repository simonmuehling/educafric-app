# Overview
Educafric is a bilingual, mobile-first EdTech platform designed to digitalize education in Africa. Its primary purpose is to reduce costs, enhance educational outcomes, and provide a scalable, culturally relevant solution. The platform offers comprehensive academic management, communication tools, financial features, and offline access, aiming to make quality education accessible and affordable across the continent. The project aims to achieve significant market penetration and improve educational infrastructure across Africa.

# User Preferences
- EXEMPTION PREMIUM PERMANENTE: Comptes sandbox et @test.educafric.com sont définitivement exemptés de TOUTES restrictions premium. Patterns d'exemption incluent @test.educafric.com, sandbox@, demo@, test@, .sandbox@, .demo@, .test@. Exemptions couvrent : restrictions de fonctionnalités, limites freemium, vérifications d'abonnement. Logs automatiques : [PREMIUM_EXEMPT] et [LIMITS_EXEMPT] pour tracking.
- PROTECTION ANTI-CONFLIT MODULES: Système de mapping des modules réorganisé avec séparation stricte par dashboard. Validation automatique des mappings pour détecter les conflits et doublons. Le module 'students' DOIT pointer vers FunctionalDirectorStudentManagement. Structure organisée : Director → Commercial → Parent → Student → Teacher → Freelancer → Shared. NE JAMAIS mélanger les mappings de modules entre dashboards différents.
- RÉSOLUTION CONFLITS ROUTES PARAMÈTRES: Problème de conflits entre routes settings résolu par réorganisation de l'ordre d'enregistrement. Routes settings définies AVANT routers externes. Ordre prioritaire : Settings → API Modules → System Routes → Services. Toujours maintenir l'ordre d'enregistrement des routes.
- NUMÉROS EDUCAFRIC AVEC AUTO-GÉNÉRATION: Site Admins peuvent créer écoles SANS pré-créer numéros EDUCAFRIC, le système génère automatiquement un numéro EDU-CM-SC-### si non fourni. Format standardisé : EDU-CM-SC-### (SC = School, séquence incrémentielle). Directors DOIVENT utiliser numéro pré-assigné, Site Admins peuvent auto-générer.
- EMAIL OPTIONNEL - TÉLÉPHONE PRIORITAIRE: Email est maintenant OPTIONNEL, le numéro de téléphone est l'identifiant principal unique. La colonne `email` dans `users` est nullable. Validation Zod et Passport strategy adaptées pour accepter email optionnel et téléphone requis (min 10 caractères). Le numéro de téléphone DOIT être unique et valide (min 10 caractères).
- NIVEAUX SCOLAIRES PERSONNALISABLES: Écoles définissent leurs propres niveaux académiques via la table `school_levels` et l'API CRUD dédiée `/api/director/school-levels`. Une interface UI est disponible. L'import de classes valide les niveaux contre les niveaux définis par l'école avec normalisation robuste et messages d'erreur clairs. Écoles DOIVENT d'abord définir leurs niveaux dans Paramètres > Académique avant d'importer des classes.
- AFFICHAGE IMMÉDIAT APRÈS IMPORT EXCEL: Données importées apparaissent IMMÉDIATEMENT sans rafraîchissement manuel grâce à double invalidation + refetch explicite dans ExcelImportButton. Tous les modules concernés (Classes, Enseignants, Élèves, Emploi de temps, Salles) bénéficient du rafraîchissement automatique. Tout nouveau module utilisant ExcelImportButton DOIT passer les queryKeys appropriées dans la prop `invalidateQueries`.
- ISOLATION MULTI-TENANT STRICTE (SCHOOL_ID): Correction systématique de l'utilisation de `user.schoolId` (valeur correcte) au lieu de `user.school_id` (toujours undefined) dans TOUTES les APIs Director. Les écoles voient maintenant LEURS propres données. TOUJOURS utiliser `user.schoolId` (avec majuscule I) pour isolation multi-tenant, JAMAIS `user.school_id`.
- ARCHITECTURE DATABASE-ONLY: TOUS les modules storage (StudentStorage, TimetableStorage, BulletinStorage, ClassStorage, etc.) utilisent UNIQUEMENT des requêtes database via Drizzle ORM. ZÉRO donnée hardcodée/mock dans le code storage. Les écoles sandbox (IDs 1-6, 15) reçoivent leurs données démo via pre-seeding dans la database réelle avec le script `server/scripts/seedSandboxData.ts` (idempotent, peut être réexécuté). Cette architecture garantit: code maintenable, comportement identique pour tous, et données démo persistantes dans la DB. NE JAMAIS ajouter de mock data arrays dans les storage modules - toujours utiliser database queries.
- SYSTÈME MULTIROLE IMPLÉMENTÉ: Impossible d'ajouter un utilisateur existant comme Teacher est résolu. Système multirole complet avec table `role_affiliations` et champs `secondaryRoles`, `activeRole`, `roleHistory`. Détection automatique des utilisateurs existants par email OU téléphone avant création. Ajout de rôle secondaire et affiliation si utilisateur existe. Toujours vérifier utilisateurs existants par email/phone AVANT création dans ANY API de création utilisateur.
- SAUVEGARDE NOM D'ÉCOLE - PROFIL DIRECTOR: Le nom d'école édité dans le profil Director se sauve maintenant correctement. L'endpoint PUT `/api/director/settings` met à jour le champ `name` dans la table `schools` quand `schoolName` est modifié. Toute modification de données école (nom, adresse, etc.) dans le profil Director DOIT mettre à jour la table `schools`, pas seulement la table `users`.
- FOND BLANC POUR TOUS LES DIALOGS D'ALERTE: TOUS les dialogs d'alerte/confirmation (DeleteConfirmationDialog et autres AlertDialogContent) DOIVENT avoir un fond blanc permanent avec la classe `bg-white`. Ceci garantit une lisibilité optimale peu importe le thème actif. Le composant `DeleteConfirmationDialog` a été mis à jour avec `<AlertDialogContent className="bg-white">`. Tout nouveau dialog d'alerte DOIT suivre ce standard.
- MOCK STUDENTS ONLY FOR SANDBOX: L'endpoint `/api/director/students` a été corrigé pour retourner UNIQUEMENT les mock students pour les utilisateurs sandbox (email contenant @test.educafric.com, @educafric.demo, sandbox@, demo@, .sandbox@, .demo@, .test@). Les écoles réelles reçoivent UNIQUEMENT les étudiants de la base de données via une requête Drizzle. JAMAIS de mock data pour les écoles réelles.
- EMPLOIS DU TEMPS DATABASE-ONLY: L'endpoint `/api/student/timetable` a été converti de mock data vers architecture database-only. Il récupère maintenant la classe de l'étudiant depuis la table `students`, puis filtre les emplois du temps depuis la table `timetables` par `classId`, `schoolId`, et `isActive=true`. L'endpoint `/api/teacher/timetable` filtre correctement par `teacherId`. Tous les endpoints d'emplois du temps utilisent UNIQUEMENT des requêtes database, conformément au principe ARCHITECTURE DATABASE-ONLY.
- MASTERSHEET DATABASE-ONLY: Le module Fiche Scolaire (Mastersheet) dans Gestion Académique utilise maintenant UNIQUEMENT des données database via l'endpoint `/api/director/bulletins/list`. Cet endpoint interroge la table `bulletinComprehensive` avec isolation multi-tenant stricte (filtre par `schoolId`, `classId`, et `term`). L'affichage inclut : informations réelles de l'école depuis `/api/director/settings`, liste des bulletins créés avec noms d'élèves/moyennes/rangs/codes de vérification, et entête d'impression bilingue format ministère (RÉPUBLIQUE DU CAMEROUN / REPUBLIC OF CAMEROON) avec logo de l'école et délégations officielles. ZÉRO mock data, tout vient de la database.
- TEACHER SUBJECT ASSIGNMENTS (MES CLASSES): Les modules enseignant récupèrent maintenant les matières/classes depuis `teacherSubjectAssignments` (module "Mes Classes") et NON depuis `timetables`. Endpoints modifiés:
  - `/api/teacher/bulletin/class-subjects/:classId` - Récupère UNIQUEMENT depuis `teacherSubjectAssignments` pour afficher automatiquement le nom de l'enseignant + matière assignée dans "Notes par matière"
  - `/api/teacher/timetable` - Récupère depuis `timetables` ET `teacherSubjectAssignments`, retourne `assignedClasses` et `assignedSubjects` dans la réponse
  - La source principale pour les matières assignées est TOUJOURS `teacherSubjectAssignments`, pas `timetables`
- PRÉSENCES 3 STATUTS: Le module Présences enseignant a maintenant 3 options de statut au lieu de 2: Présent (vert), Retard (orange), Absent (rouge). Chaque élève a 3 boutons cliquables avec icônes (CheckCircle, Clock, XCircle). POST `/api/teacher/attendance` et GET `/api/teacher/profile` endpoints ajoutés.
- TABLE ENROLLMENTS (PAS CLASS_ENROLLMENT): La table pour les inscriptions d'élèves aux classes est `enrollments`, PAS `class_enrollment`. Structure: `id`, `student_id`, `class_id`, `academic_year_id`, `enrollment_date`, `status`. TOUJOURS utiliser `enrollments` dans les requêtes SQL pour récupérer les élèves d'une classe.
- TABLE PARENT_STUDENT_RELATIONS: Pour lier parents et élèves, utiliser la table `parent_student_relations` (colonnes: `id`, `parent_id`, `student_id`, `relationship`, `is_primary`, `created_at`). NE JAMAIS chercher un `parent_id` dans la table `users` - cette colonne n'existe pas. Exemple SQL: `SELECT parent_id FROM parent_student_relations WHERE student_id FROM (...)`.
- ATTENDANCE STUDENT ID FLEXIBLE: L'endpoint POST `/api/teacher/attendance` accepte les deux formats: `student.id` OU `student.studentId` dans le tableau `students`. Le code utilise `const studentIdValue = student.id || student.studentId` pour compatibilité maximale.
- NOTIFICATIONS 3 CANAUX ACTIFS: Système de notifications automatiques avec 3 canaux: Email (Hostinger SMTP), WhatsApp (Direct API), PWA (Push notifications). Configuration dans `[AUTO_NOTIFICATIONS]`. Événements notifiés: attendance (absences/retards), grades, payments, geolocation, onlineClasses, subscriptions.
- EMPLOI DU TEMPS SIMPLIFIÉ: Module TeacherTimetable simplifié - onglets "Demandes" et "Réponses Admin" supprimés. Les enseignants voient uniquement leur planning sans workflow de demande de changement.
- CARTE D'IDENTITÉ ÉTUDIANTE - MODÈLE STANDARD: Le design de la carte d'identité étudiant (StudentIDCard.tsx) est le modèle OFFICIEL pour TOUTES les écoles Educafric. Fonctionnalités: impression mobile-friendly (détection automatique smartphone + instructions PDF), impression COULEUR garantie (`-webkit-print-color-adjust: exact !important`), signature digitale du directeur depuis `/api/signatures/principal`, QR code de vérification, format carte crédit (85.6mm x 54mm), recto/verso avec contacts urgence. Sur mobile: approche blob URL + fallback iframe avec un bouton fermer. TOUJOURS utiliser ce composant pour les cartes d'identité.
- MESSAGES ÉLÈVE - ENVOI PARENTS / RÉCEPTION TOUS: RÈGLE MÉTIER - Les élèves peuvent ENVOYER des messages UNIQUEMENT à leurs parents, mais peuvent RECEVOIR des messages de TOUS les profils (parents, enseignants, directeur, école). L'endpoint `POST /api/student/messages/parent` est réservé aux envois vers envois vers parents liés via `parent_student_relations`. L'endpoint `GET /api/student/messages` retourne TOUS les messages reçus. Interface avec onglets de filtrage (Tous, Parents, Enseignants, École) et bouton de réponse visible uniquement pour messages parents.
- ALWAYS consolidate ALL dashboards (Teacher, Student, Parent, Freelancer, Commercial, SiteAdmin) when making changes.
- NEVER make partial updates to only some dashboards.
- ALWAYS preserve button functionality when making changes - buttons must remain functional.
- DOCUMENTS MUST APPEAR INSTANTLY: User is frustrated that document creation takes hours - streamline to work immediately.
- DOCUMENT DIRECTORY STANDARD: ALL documents MUST be placed in `/public/documents/` directory with lowercase kebab-case naming.
- DOCUMENT CREATION METHOD: Use consolidated EDUCAFRIC system:
  1. Create specialized PDF generator method in `server/services/pdfGenerator.ts`.
  2. Add document to commercial docs list in `server/routes.ts` (both view and download routes).
  3. Create HTML version in `/public/documents/` for web viewing.
  4. Update alphabetical index in `00-index-documents-alphabetique.html`.
  5. Test via API routes `/api/commercial/documents/{id}/download` and direct HTML access.

# System Architecture
- **UI/UX Decisions**: The platform features a custom African-themed, mobile-first, and PWA-enabled UI, built using Radix UI and Shadcn/UI with Tailwind CSS. All alert and confirmation dialogs must consistently use a `bg-white` background. A standardized Student ID Card template, optimized for mobile-friendly color printing, digital signatures, and QR codes, is uniformly applied across all schools. A dedicated sandbox environment provides realistic demo data.
- **Technical Implementations**:
    - **Frontend**: Developed with React (TypeScript), using Wouter for routing and TanStack Query for efficient data fetching. It is PWA-enabled, with a React Native application for Android.
    - **Backend**: Powered by an Express.js RESTful API.
    - **Database & ORM**: Utilizes PostgreSQL on Neon Serverless, with Drizzle ORM managing all database interactions, ensuring strict multi-tenancy isolation through `user.schoolId`.
    - **Authentication**: Implements session-based authentication using `express-session` and `Passport.js`, including Firebase Google OAuth. The system features robust role-based access control (8 roles) and an Intrusion Detection System (IDS), supporting multi-role users via the `role_affiliations` table.
    - **Route Architecture**: Express.js route registration prioritizes direct routes (Settings, API Modules, System Routes) over external routers to prevent conflicts and ensure consistent routing behavior.
    - **Cache Management**: `queryClient.ts` incorporates `serializeQueryKey()` to prevent query key collisions and ensure data integrity.
    - **Module Loading**: `fastModuleLoader.ts` includes `validateMappings()` for automatic conflict detection and resolution in module mappings.
    - **Document Management**: A centralized system manages documents with digital signatures, PDF generation, and ensures instant appearance. All documents adhere to a standardized `/public/documents/` directory structure with lowercase kebab-case naming.
- **Feature Specifications**: Key features include real-time attendance tracking (Present, Late, Absent), flexible timetable management, multi-channel notifications (Email, WhatsApp, PWA), bilingual templates, integrated payment methods, GPS tracking, iCal/ICS export, bulk Excel import capabilities, Competency-Based Approach (CBA) bulletin generation, and Jitsi Meet integration for online classes.

# External Dependencies
- **Neon Database**: Serverless PostgreSQL database.
- **Stripe**: Payment processing gateway.
- **Firebase**: Google OAuth authentication.
- **WhatsApp**: Direct messaging API for automated notifications.
- **Hostinger**: SMTP services for email notifications.
- **Jitsi Meet**: Video conferencing integration for online classes.