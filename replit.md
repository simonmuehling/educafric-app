# Educafric

### Overview
Educafric is a comprehensive, bilingual, mobile-first educational technology platform designed for the African market. Its core purpose is to digitalize education by integrating academic management, communication, and financial features. The platform aims to reduce school costs, improve educational outcomes, and support high user volumes, addressing critical needs and capitalizing on significant market potential in African education with a robust, scalable, and culturally relevant solution.

### Recent Changes (November 29, 2025)
- **TEACHER DASHBOARD MODULES DATA FLOW**: Modules enseignant (Devoirs, Contenu Pédagogique, Bibliothèque, Communications) utilisent maintenant les APIs avec isolation multi-tenant stricte. Endpoints ajoutés: `GET /api/teacher/subjects` (matières assignées via timetables), `GET /api/teacher/classes-with-parents` (classes avec élèves/parents via enrollments), `GET /api/teacher/assigned-schools` (écoles assignées). CreateEducationalContent récupère dynamiquement les matières assignées au lieu d'une liste hardcodée. Director view `/api/educational-content/school/all` retourne données réelles (vide pour écoles réelles, demo pour sandbox) - table educational_content à créer. Communications module intègre classes-with-parents pour ciblage parents.

### Recent Changes (November 26, 2025)
- **OFFLINE DATA READINESS CHECK**: Système de vérification des données hors ligne avant accès aux modules. Le contexte `OfflinePremiumContext` inclut maintenant `offlineDataReady`, `offlineDataStatus` (compteurs classes/students/teachers), `isPreparing`, et `prepareOfflineData()`. Le composant `OfflineDataNotReadyModal` s'affiche quand l'utilisateur est hors ligne sans données locales, avec option de préparer l'appareil quand en ligne. Endpoints backend : GET `/api/offline-sync/classes`, GET `/api/offline-sync/students`, GET `/api/offline-sync/teachers` pour téléchargement en bloc. Modules critiques (ClassManagement, FunctionalDirectorStudentManagement, FunctionalDirectorTeacherManagement) intègrent le modal et le hook `useOfflineDataCheck()`. Hook vérifie IndexedDB via `checkOfflineDataStatus()` pour détecter données locales existantes.
- **MODULE GESTION UTILISATEURS - SITE ADMIN**: Site Admin peut maintenant voir et administrer tous les utilisateurs réels (Teachers, Parents, Students, Directors) via le module "Utilisateurs" dans son dashboard. Endpoints backend : GET `/api/siteadmin/users` (récupère tous les utilisateurs réels avec informations école via JOIN), PATCH `/api/siteadmin/users/:userId/status` (activer/désactiver utilisateur), DELETE `/api/siteadmin/users/:userId` (supprimer utilisateur). Interface frontend avec recherche, filtres par rôle (Teacher/Parent/Student/Director), tableau avec badges de rôle colorés, actions toggle statut actif/inactif, édition et suppression. Les utilisateurs sont récupérés depuis la database avec isolation multi-tenant (affiche école associée). Le module permet administration complète des profils utilisateurs comme demandé.
- **COMPILATION AUTOMATIQUE BULLETINS DEPUIS NOTES APPROUVÉES**: Workflow complet implémenté pour compiler automatiquement les bulletins depuis les notes approuvées par le directeur. Composant `CompileBulletinsFromGrades` dans l'onglet "Bulletins" permet de sélectionner classe/trimestre/année et affiche la liste des élèves dont TOUTES les notes sont approuvées. Click "Compiler" crée automatiquement le bulletin dans `teacher_bulletins` avec status='compiled_from_grades' et reviewStatus='pending'. Endpoints: GET `/api/director/students-ready-for-compilation` (liste élèves prêts avec LEFT JOIN pour exclure déjà compilés), POST `/api/director/compile-approved-grades` (compilation avec protection anti-doublons 409). Badge indigo distinctif "Compilé depuis Notes" dans `TeacherSubmittedBulletins`. Double invalidation de cache (teacher-bulletins + ready-students) pour rafraîchissement immédiat. Élève disparaît de la liste après compilation grâce au filtre `!hasCompiledBulletin` dans le LEFT JOIN.

### User Preferences
- **EXEMPTION PREMIUM PERMANENTE**: Comptes sandbox et @test.educafric.com sont définitivement exemptés de TOUTES restrictions premium. Patterns d'exemption incluent @test.educafric.com, sandbox@, demo@, test@, .sandbox@, .demo@, .test@. Exemptions couvrent : restrictions de fonctionnalités, limites freemium, vérifications d'abonnement. Logs automatiques : [PREMIUM_EXEMPT] et [LIMITS_EXEMPT] pour tracking.
- **PROTECTION ANTI-CONFLIT MODULES**: Système de mapping des modules réorganisé avec séparation stricte par dashboard. Validation automatique des mappings pour détecter les conflits et doublons. Le module 'students' DOIT pointer vers FunctionalDirectorStudentManagement. Structure organisée : Director → Commercial → Parent → Student → Teacher → Freelancer → Shared. NE JAMAIS mélanger les mappings de modules entre dashboards différents.
- **RÉSOLUTION CONFLITS ROUTES PARAMÈTRES**: Problème de conflits entre routes settings résolu par réorganisation de l'ordre d'enregistrement. Routes settings définies AVANT routers externes. Ordre prioritaire : Settings → API Modules → System Routes → Services. Toujours maintenir l'ordre d'enregistrement des routes.
- **NUMÉROS EDUCAFRIC AVEC AUTO-GÉNÉRATION**: Site Admins peuvent créer écoles SANS pré-créer numéros EDUCAFRIC, le système génère automatiquement un numéro EDU-CM-SC-### si non fourni. Format standardisé : EDU-CM-SC-### (SC = School, séquence incrémentielle). Directors DOIVENT utiliser numéro pré-assigné, Site Admins peuvent auto-générer.
- **EMAIL OPTIONNEL - TÉLÉPHONE PRIORITAIRE**: Email est maintenant OPTIONNEL, le numéro de téléphone est l'identifiant principal unique. La colonne `email` dans `users` est nullable. Validation Zod et Passport strategy adaptées pour accepter email optionnel et téléphone requis (min 10 caractères). Le numéro de téléphone DOIT être unique et valide (min 10 caractères).
- **NIVEAUX SCOLAIRES PERSONNALISABLES**: Écoles définissent leurs propres niveaux académiques via la table `school_levels` et l'API CRUD dédiée `/api/director/school-levels`. Une interface UI est disponible. L'import de classes valide les niveaux contre les niveaux définis par l'école avec normalisation robuste et messages d'erreur clairs. Écoles DOIVENT d'abord définir leurs niveaux dans Paramètres > Académique avant d'importer des classes.
- **AFFICHAGE IMMÉDIAT APRÈS IMPORT EXCEL**: Données importées apparaissent IMMÉDIATEMENT sans rafraîchissement manuel grâce à double invalidation + refetch explicite dans ExcelImportButton. Tous les modules concernés (Classes, Enseignants, Élèves, Emploi du temps, Salles) bénéficient du rafraîchissement automatique. Tout nouveau module utilisant ExcelImportButton DOIT passer les queryKeys appropriées dans la prop `invalidateQueries`.
- **ISOLATION MULTI-TENANT STRICTE (SCHOOL_ID)**: Correction systématique de l'utilisation de `user.schoolId` (valeur correcte) au lieu de `user.school_id` (toujours undefined) dans TOUTES les APIs Director. Les écoles voient maintenant LEURS propres données. TOUJOURS utiliser `user.schoolId` (avec majuscule I) pour isolation multi-tenant, JAMAIS `user.school_id`.
- **ARCHITECTURE DATABASE-ONLY**: TOUS les modules storage (StudentStorage, TimetableStorage, BulletinStorage, ClassStorage, etc.) utilisent UNIQUEMENT des requêtes database via Drizzle ORM. ZÉRO donnée hardcodée/mock dans le code storage. Les écoles sandbox (IDs 1-6, 15) reçoivent leurs données démo via pre-seeding dans la database réelle avec le script `server/scripts/seedSandboxData.ts` (idempotent, peut être réexécuté). Cette architecture garantit: code maintenable, comportement identique pour tous, et données démo persistantes dans la DB. NE JAMAIS ajouter de mock data arrays dans les storage modules - toujours utiliser database queries.
- **SYSTÈME MULTIROLE IMPLÉMENTÉ**: Impossible d'ajouter un utilisateur existant comme Teacher est résolu. Système multirole complet avec table `role_affiliations` et champs `secondaryRoles`, `activeRole`, `roleHistory`. Détection automatique des utilisateurs existants par email OU téléphone avant création. Ajout de rôle secondaire et affiliation si utilisateur existe. Toujours vérifier utilisateurs existants par email/phone AVANT création dans ANY API de création utilisateur.
- **SAUVEGARDE NOM D'ÉCOLE - PROFIL DIRECTOR**: Le nom d'école édité dans le profil Director se sauvegarde maintenant correctement. L'endpoint PUT `/api/director/settings` met à jour le champ `name` dans la table `schools` quand `schoolName` est modifié. Toute modification de données école (nom, adresse, etc.) dans le profil Director DOIT mettre à jour la table `schools`, pas seulement la table `users`.
- **FOND BLANC POUR TOUS LES DIALOGS D'ALERTE**: TOUS les dialogs d'alerte/confirmation (DeleteConfirmationDialog et autres AlertDialogContent) DOIVENT avoir un fond blanc permanent avec la classe `bg-white`. Ceci garantit une lisibilité optimale peu importe le thème actif. Le composant `DeleteConfirmationDialog` a été mis à jour avec `<AlertDialogContent className="bg-white">`. Tout nouveau dialog d'alerte DOIT suivre ce standard.
- **MOCK STUDENTS ONLY FOR SANDBOX**: L'endpoint `/api/director/students` a été corrigé pour retourner UNIQUEMENT les mock students pour les utilisateurs sandbox (email contenant @test.educafric.com, @educafric.demo, sandbox@, demo@, .sandbox@, .demo@, .test@). Les écoles réelles reçoivent UNIQUEMENT les étudiants de la base de données via une requête Drizzle. JAMAIS de mock data pour les écoles réelles.
- **EMPLOIS DU TEMPS DATABASE-ONLY**: L'endpoint `/api/student/timetable` a été converti de mock data vers architecture database-only. Il récupère maintenant la classe de l'étudiant depuis la table `students`, puis filtre les emplois du temps depuis la table `timetables` par `classId`, `schoolId`, et `isActive=true`. L'endpoint `/api/teacher/timetable` filtre correctement par `teacherId`. Tous les endpoints d'emplois du temps utilisent UNIQUEMENT des requêtes database, conformément au principe ARCHITECTURE DATABASE-ONLY.
- **MASTERSHEET DATABASE-ONLY**: Le module Fiche Scolaire (Mastersheet) dans Gestion Académique utilise maintenant UNIQUEMENT des données database via l'endpoint `/api/director/bulletins/list`. Cet endpoint interroge la table `bulletinComprehensive` avec isolation multi-tenant stricte (filtre par `schoolId`, `classId`, et `term`). L'affichage inclut : informations réelles de l'école depuis `/api/director/settings`, liste des bulletins créés avec noms d'élèves/moyennes/rangs/codes de vérification, et entête d'impression bilingue format ministère (RÉPUBLIQUE DU CAMEROUN / REPUBLIC OF CAMEROON) avec logo de l'école et délégations officielles. ZÉRO mock data, tout vient de la database.
- ALWAYS consolidate ALL dashboards (Teacher, Student, Parent, Freelancer, Commercial, SiteAdmin) when making changes.
- NEVER make partial updates to only some dashboards.
- ALWAYS preserve button functionality when making changes - buttons must remain functional.
- **DOCUMENTS MUST APPEAR INSTANTLY:** User is frustrated that document creation takes hours - streamline to work immediately.
- **DOCUMENT DIRECTORY STANDARD:** ALL documents MUST be placed in `/public/documents/` directory with lowercase kebab-case naming.
- **DOCUMENT CREATION METHOD:** Use consolidated EDUCAFRIC system:
  1. Create specialized PDF generator method in `server/services/pdfGenerator.ts`.
  2. Add document to commercial docs list in `server/routes.ts` (both view and download routes).
  3. Create HTML version in `/public/documents/` for web viewing.
  4. Update alphabetical index in `00-index-documents-alphabetique.html`.
  5. Test via API routes `/api/commercial/documents/{id}/download` and direct HTML access.

### System Architecture
- **Frontend**: React (TypeScript) with Wouter, TanStack Query, Radix UI + Shadcn/UI (Tailwind CSS) for an African-themed, PWA, mobile-optimized design. React Native for Android.
- **Backend**: Express.js (RESTful API) with Drizzle ORM and PostgreSQL.
- **Authentication**: Session-based with `express-session` and `Passport.js`, Firebase Google OAuth. Features role-based access control (8 roles), enhanced security with BCrypt, consolidated error handling, helmet, cors, rate-limiting, 2FA, and IDS.
- **Database**: PostgreSQL on Neon Serverless, designed for multi-tenancy with tables for users, schools, classes, grades, attendance, homework, payments, communication logs, geolocation, structured by academic year/term.
- **Key Features**: Offline-First capabilities (Service Worker, IndexedDB, Background Sync, Offline Premium), African-style grade management, real-time attendance, flexible timetables, multi-channel notifications, bilingual templates, payment methods, GPS tracking, geofencing, real-time monitoring, centralized document management with digital signatures and PDF generation, bidirectional connection system, iCal/ICS export, bulk Excel imports, Competency-Based Approach bulletin generation, Jitsi Meet integration for online classes, and Teacher Hybrid Work Mode.
- **UI/UX Decisions**: Custom African-themed UI, PWA and mobile-first approach, dedicated sandbox environment with realistic demo data.

### External Dependencies
- **Neon Database**: Serverless PostgreSQL database.
- **Stripe**: Payment processing gateway.
- **Firebase**: Google OAuth for authentication.
- **WhatsApp**: Click-to-Chat integration for communications.
- **Hostinger**: SMTP services for email notifications.
- **Jitsi Meet**: Video conferencing for online classes.