# Overview
Educafric is a bilingual, mobile-first EdTech platform tailored for the African market. Its core purpose is to provide comprehensive academic management, communication tools, financial services, and offline capabilities. The platform aims to significantly enhance educational accessibility and learning outcomes across Africa, targeting substantial market penetration and user growth by addressing critical educational needs on the continent.

# User Preferences
- EXEMPTION PREMIUM PERMANENTE: Comptes sandbox et @test.educafric.com sont d√©finitivement exempt√©s de TOUTES restrictions premium. Patterns d'exemption incluent @test.educafric.com, sandbox@, demo@, test@, .sandbox@, .demo@, .test@. Exemptions couvrent : restrictions de fonctionnalit√©s, limites freemium, v√©rifications d'abonnement. Logs automatiques : [PREMIUM_EXEMPT] et [LIMITS_EXEMPT] pour tracking.
- PROTECTION ANTI-CONFLIT MODULES: Syst√®me de mapping des modules r√©organis√© avec s√©paration stricte par dashboard. Validation automatique des mappings pour d√©tecter les conflits et doublons. Le module 'students' DOIT pointer vers FunctionalDirectorStudentManagement. Structure organis√©e : Director ‚Üí Commercial ‚Üí Parent ‚Üí Student ‚Üí Teacher ‚Üí Freelancer ‚Üí Shared. NE JAMAIS m√©langer les mappings de modules entre dashboards diff√©rents.
- R√âSOLUTION CONFLITS ROUTES PARAM√àTRES: Probl√®me de conflits entre routes settings r√©solu par r√©organisation de l'ordre d'enregistrement. Routes settings d√©finies AVANT routers externes. Ordre prioritaire : Settings ‚Üí API Modules ‚Üí System Routes ‚Üí Services. Toujours maintenir l'ordre d'enregistrement des routes.
- NUM√âROS EDUCAFRIC AVEC AUTO-G√âN√âRATION: Site Admins peuvent cr√©er √©coles SANS pr√©-creer num√©ros EDUCAFRIC, le syst√®me g√©n√®re automatiquement un num√©ro EDU-CM-SC-### si non fourni. Format standardis√© : EDU-CM-SC-### (SC = School, s√©quence incr√©mentielle). Directors DOVENT utiliser num√©ro pr√©-assign√©, Site Admins peuvent auto-g√©n√©rer.
- EMAIL OPTIONNEL - T√âL√âPHONE PRIORITAIRE: Email est maintenant OPTIONNEL, le num√©ro de t√©l√©phone est l'identifiant principal unique. La colonne `email` dans `users` est nullable. Validation Zod et Passport strategy adapt√©es pour accepter email optionnel et t√©l√©phone requis (min 10 caract√®res). Le num√©ro de t√©l√©phone DOIT √™tre unique et valide (min 10 caract√®res).
- NIVEAUX SCOLAIRES PERSONNALISABLES: √âcoles d√©finissent leurs propres niveaux acad√©miques via la table `school_levels` et l'API CRUD d√©di√©e `/api/director/school-levels`. Une interface UI est disponible. L'import de classes valide les niveaux contre les niveaux d√©finis par l'√©cole avec normalisation robuste et messages d'erreur claires. √âcoles DOVENT d'abord d√©finir leurs niveaux dans Param√®tres > Acad√©mique avant d'importer les classes.
- AFFICHAGE IMM√âDIAT APRES IMPORT EXCEL: Donn√©es import√©es apparaissent IMM√âDIATEMENT sans rafra√Æchissement manuel gr√¢ce √† double invalidation + refetch explicite dans ExcelImportButton. Tous les modules concern√©s (Classes, Enseignants, √âl√®ves, Emploi de temps, Salles) b√©n√©ficient du rafra√Æchissement automatique. Tout nouveau module utilisant ExcelImportButton DOIT passer les queryKeys appropri√©es dans la prop `invalidateQueries`.
- ISOLATION MULTI-TENANT STRICTE (SCHOOL_ID): Correction syst√©matique de l'utilisation de `user.schoolId` (valeur correcte) au lieu de `user.school_id` (toujours undefined) dans TOUTES les APIs Director. Les √©coles voient maintenant LEURS propres donn√©es. TOUJOURS utiliser `user.schoolId` (avec majuscule I) pour isolation multi-tenant, JAMAIS `user.school_id`.
- ARCHITECTURE DATABASE-ONLY: TOUS les modules storage (StudentStorage, TimetableStorage, BulletinStorage, ClassStorage, etc.) utilisent UNIQUEMENT des requ√™tes database via Drizzle ORM. Z√âRO donn√©e hardcod√©e/mock dans le code storage. Les √©coles sandbox (IDs 1-6, 15) re√ßoivent leurs donn√©es d√©mo via pre-seeding dans la database r√©elle avec le script `server/scripts/seedSandboxData.ts` (idempotent, peut √™tre r√©ex√©cut√©). Cette architecture garantit: code maintenable, comportement identique pour tous, et donn√©es d√©mo persistantes dans la DB. NE JAMAIS ajouter de mock data arrays dans les storage modules - toujours utiliser database queries.
- SYST√àME MULTIROLE IMPL√âMENT√â: Impossible d'ajouter un utilisateur existant comme Teacher est r√©solu. Syst√®me multirole complet avec table `role_affiliations` et champs `secondaryRoles`, `activeRole`, `roleHistory`. D√©tection automatique des utilisateurs existants par email OU t√©l√©phone avant cr√©ation. Ajout de r√¥le secondaire et affiliation si utilisateur existe. Toujours v√©rifier utilisateurs existants par email/phone AVANT cr√©ation dans ANY API de cr√©ation utilisateur.
- SAUVEGARDE NOM D'√âCOLE - PROFIL DIRECTOR: Le nom d'√©cole √©dit√© dans le profil Director se sauve maintenant correctement. L'endpoint PUT `/api/director/settings` met √† jour le champ `name` dans la table `schools` quand `schoolName` est modifi√©. Toute modification de donn√©es √©cole (nom, adresse, etc.) dans le profil Director DOIT mettre √† jour la table `schools`, pas seulement la table `users`.
- FOND BLANC POUR TOUS LES DIALOGS D'ALERTE: TOUS les dialogs d'alerte/confirmation (DeleteConfirmationDialog et autres AlertDialogContent) DOIVENT avoir un fond blanc permanent avec la classe `bg-white`. Ceci garantit une lisibilit√© optimale peu importe le th√®me actif. Le composant `DeleteConfirmationDialog` a √©t√© mis √† jour avec `<AlertDialogContent className="bg-white">`. Tout nouveau dialog d'alerte DOIT suivre ce standard.
- MOCK STUDENTS ONLY FOR SANDBOX: L'endpoint `/api/director/students` a √©t√© corrig√© pour retourner UNIQUEMENT les mock students pour les utilisateurs sandbox (email contenant @test.educafric.com, @educafric.demo, sandbox@, demo@, .sandbox@, .demo@, .test@). Les √©coles r√©elles re√ßoivent UNIQUEMENT les √©tudiants de la base de donn√©es via une requ√™te Drizzle. JAMAIS de mock data pour les √©coles r√©elles.
- EMPLOIS DU TEMPS DATABASE-ONLY: L'endpoint `/api/student/timetable` a √©t√© converti de mock data vers architecture database-only. Il r√©cup√®re maintenant la classe de l'√©tudiant depuis la table `students`, puis filtre les emplois du temps depuis la table `timetables` par `classId`, `schoolId`, et `isActive=true`. L'endpoint `/api/teacher/timetable` filtre correctement par `teacherId`. Tous les endpoints d'emplois du temps utilisent UNIQUEMENT des requ√™tes database, conform√©ment au principe ARCHITECTURE DATABASE-ONLY.
- MASTERSHEET DATABASE-ONLY: Le module Fiche Scolaire (Mastersheet) dans Gestion Acad√©mique utilise maintenant UNIQUEMENT des donn√©es database via l'endpoint `/api/director/bulletins/list`. Cet endpoint interroge la table `bulletinComprehensive` avec isolation multi-tenant stricte (filtre par `schoolId`, `classId`, et `term`). L'affichage inclus : informations r√©elles de l'√©cole depuis `/api/director/settings`, liste des bulletins cr√©√©s avec noms d'√©l√®ves/moyennes/rangs/codes de v√©rification, et ent√™te d'impression bilingue format minist√®re (R√âPUBLIQUE DU CAMEROUN / REPUBLIC OF CAMEROON) avec logo de l'√©cole et d√©l√©gations officielles. Z√âRO mock data, tout vient de la database.
- TEACHER SUBJECT ASSIGNMENTS (MES CLASSES): Les modules enseignant r√©cup√®rent maintenant les mati√®res/classes depuis `teacherSubjectAssignments` (module "Mes Classes") et NON depuis `timetables`. Endpoints modifi√©s:
  - `/api/teacher/bulletin/class-subjects/:classId` - R√©cup√®re UNIQUEMENT depuis `teacherSubjectAssignments` pour afficher automatiquement le nom de l'enseignant + mati√®re assign√©e dans "Notes par mati√®re"
  - `/api/teacher/timetable` - R√©cup√®re depuis `timetables` ET `teacherSubjectAssignments`, retourne `assignedClasses` et `assignedSubjects` dans la r√©ponse
  - La source principale pour les mati√®res assign√©es est TOUJOURS `teacherSubjectAssignments`, pas `timetables`
- PR√âSENCES 3 STATUTS: Le module Pr√©sences enseignant a maintenant 3 options de statut au lieu de 2: Pr√©sent (vert), Retard (orange), Absent (rouge). Chaque √©l√®ve a 3 boutons cliquables avec ic√¥nes (CheckCircle, Clock, XCircle). POST `/api/teacher/attendance` et GET `/api/teacher/profile` endpoints ajout√©s.
- TABLE ENROLLMENTS (PAS CLASS_ENROLLMENT): La table pour les inscriptions d'√©l√®ves aux classes est `enrollments`, PAS `class_enrollment`. Structure: `id`, `student_id`, `academic_year_id`, `enrollment_date`, `status`. TOUJOURS utiliser `enrollments` dans les requ√™tes SQL pour r√©cup√©rer les √©l√®ves d'une classe.
- TABLE PARENT_STUDENT_RELATIONS: Pour lier parents et √©l√®ves, utiliser la table `parent_student_relations` (colonnes: `id`, `parent_id`, `student_id`, `relationship`, `is_primary`, `created_at`). NE JAMAIS chercher un `parent_id` dans la table `users` - cette colonne n'existe pas. Exemple SQL: `SELECT parent_id FROM parent_student_relations WHERE student_id FROM (...)`.
- ATTENDANCE STUDENT ID FLEXIBLE: L'endpoint POST `/api/teacher/attendance` accepte les deux formats: `student.id` OU `student.studentId` dans le tableau `students`. Le code utilise `const studentIdValue = student.id || student.studentId` pour compatibilit√© maximale.
- NOTIFICATIONS 3 CANAUX ACTIFS: Syst√®me de notifications automatiques avec 3 canaux: Email (Hostinger SMTP), WhatsApp (Direct API), PWA (Push notifications). Configuration dans `[AUTO_NOTIFICATIONS]`. √âv√©nements notifi√©s: attendance (absences/retards), grades, payments, geolocation, onlineClasses, subscriptions.
- EMPLOI DU TEMPS SIMPLIFI√â: Module TeacherTimetable simplifi√© - onglets "Demandes" et "R√©ponses Admin" supprim√©s. Les enseignants voient uniquement leur planning sans workflow de demande de changement.
- CARTE D'IDENTIT√â √âTUDIANTE - MOD√àLE STANDARD: Le design de la carte d'identit√© √©tudiant (StudentIDCard.tsx) est le mod√®le OFFICIEL pour TOUTES les √©coles Educafric. Fonctionnalit√©s: impression mobile-friendly (d√©tection automatique smartphone + instructions PDF), impression COULEUR garantie (`-webkit-print-color-adjust: exact !important`), signature digitale du directeur depuis `/api/signatures/principal`, QR code de v√©rification, format carte cr√©dit (85.6mm x 54mm), recto/verso avec contacts urgence. Sur mobile: approche blob URL + fallback iframe avec un bouton fermer. TOUJOURS utiliser ce composant pour les cartes d'identit√©.
- MESSAGES √âL√àVE - ENVOI PARENTS / R√âCEPTION TOUS: R√àGLE M√âTIER - Les √©l√®ves peuvent ENVOYER des messages UNIQUEMENT √† leurs parents, mais peuvent RECEVOIR des messages de TOUS les profils (parents, enseignants, directeur, √©cole). L'endpoint `POST /api/student/messages/parent` est r√©serv√© aux envois vers parents li√©s via `parent_student_u_relations`. L'endpoint `GET /api/student/messages` retourne TOUS les messages re√ßus. Interface avec onglets de filtrage (Tous, Parents, Enseignants, √âcole) et bouton de r√©ponse visible uniquement pour messages parents.
- ALWAYS consolidate ALL dashboards (Teacher, Student, Parent, Freelancer, Commercial, SiteAdmin) when making changes.
- NEVER make partial updates to only some dashboards.
- ALWAYS preserve button functionality when making changes - buttons must remain functional.
- DOCUMENTS MUST APPEAR INSTANTLY: User is frustrated that document creation takes hours - streamline to work immediately.
- DOCUMENT DIRECTORY STANDARD: ALL documents MUST be placed in `/public/documents/` directory with lowercase kebab-case naming.
- DOCUMENT CREATION METHOD: Use consolidated EDUCAFRIC system:
  1. Create specialized PDF generator method in `server/services/pdfGenerator.ts`.
  2. Add document to commercial docs list in `server/routes.ts` (both view and download routes).
  3. Create HTML version in `/public/documents/` for web viewing.
  4. Update alphabetical index in `00-index-documents-alphabetique.html`.
  5. Test via API routes `/api/commercial/documents/{id}/download` and direct HTML access.
- LOGO ROBUSTE MULTI-FALLBACK: Les composants Logo.tsx et FrontpageNavbar.tsx utilisent un syst√®me de fallback √† 4 niveaux pour garantir l'affichage du logo: 1) /educafric-128.png, 2) /educafric-512.png, 3) /favicon.ico, 4) Ic√¥ne GraduationCap. Le texte "Educafric" est TOUJOURS visible ind√©pendamment du statut de l'image. LOGO_SOURCES array avec useState pour tracking des erreurs. NE JAMAIS supprimer ces fallbacks.
- MODULE COURS EN LIGNE - R√àGLES D'ACC√àS CRITIQUES:
  **INTERFACE VISIBLE POUR TOUS**: TOUS les enseignants DOIVENT voir l'interface compl√®te avec les 3 onglets ("Mes Cours", "Sessions √† Venir", "Cr√©er un Cours") - JAMAIS cacher les onglets bas√© sur le statut d'abonnement.
  **LOGIQUE FRONTEND**: La condition `!hasPersonalSubscription` affiche les onglets avec restrictions (prompts d'achat). La condition `hasPersonalSubscription` affiche l'interface compl√®te avec cr√©ation de cours.
  **3 NIVEAUX D'ACC√àS**:
  1) Abonnement Personnel (activationType='teacher') ‚Üí Acc√®s complet, cr√©ation de cours ind√©pendants
  2) Activation √âcole (activationType='school') ‚Üí Sessions assign√©es uniquement, prompt achat pour cr√©er cours
  3) Sans Abonnement (activationType=null) ‚Üí Interface visible, tous les boutons de cr√©ation montrent prompt d'achat
  **COURS LI√â √Ä UNE √âCOLE NON ACTIV√â**: Si `!hasSchoolAccess`, afficher un avertissement orange expliquant: "Module non activ√© par votre √©cole" avec 2 options: a) Demander au directeur de contacter Educafric, b) Acheter un abonnement personnel.
  **BACKEND**: `onlineClassAccessService.checkAccess()` retourne TOUJOURS `allowed: true` pour les enseignants, avec flags `canCreateCourses` et `canStartSession` pour contr√¥ler les actions.
  **MULTI-R√îLE**: V√©rifier `effectiveRole = user.activeRole || user.role` pour compatibilit√© Parent‚ÜíTeacher.
  **NE JAMAIS**: Cacher les onglets de l'interface bas√© sur `hasPersonalSubscription` ou `hasSchoolAccess` - toujours montrer l'interface compl√®te avec restrictions contextuelles.
  **DIRECTEUR - AVERTISSEMENT ACTIVATION**: Dans OnlineClassesManager.tsx (director), v√©rifier `isSchoolActivated` via `/api/online-class-activations/school-status`. Si `!isSchoolActivated`, afficher un bandeau orange avec bouton WhatsApp pour contacter Educafric.
  **BOUTON WHATSAPP**: Tous les boutons "Contacter Educafric" doivent ouvrir WhatsApp (pas email) avec message pr√©-rempli: `https://wa.me/237699999999?text=...`
- LOGO √âCOLE PERSISTANT BULLETINS: Le logo de l'√©cole DOIT √™tre r√©cup√©r√© depuis `/api/director/settings` (champ `school.logoUrl` ou `profile.logoUrl`) et stock√© dans `formData.schoolLogoUrl`. Tous les endroits g√©n√©rant des bulletins DOIVENT utiliser `formData.schoolLogoUrl` au lieu de donn√©es hardcod√©es. Le champ database est `schools.logoUrl` (pas `logo`). L'endpoint `PUT /api/school/logo` utilise `db.update(schools).set({ logoUrl: ... })` pour persister.
- LOGO PDF HYBRIDE MULTI-PATH: Le g√©n√©rateur PDF (`pdfGenerator.ts`) utilise un syst√®me de r√©solution hybride pour trouver les logos d'√©cole. Chemins test√©s: 1) Chemin normalis√©, 2) `public/` + chemin, 3) `public/uploads/logos/` + nom fichier, 4) Chemin relatif depuis projet. Logs d√©taill√©s: `[PDF_LOGO] üîç Searching logo...`. Le formulaire de bulletin affiche un aper√ßu du logo + option d'upload manuel dans la section "Informations √âcole". Les logos sont stock√©s dans `public/uploads/logos/` avec noms format `school-{id}-{timestamp}.{ext}`.
- LOGOS √âCOLE - FORMAT GIF INTERDIT: Le format GIF n'est PAS support√© par le g√©n√©rateur PDF (pdf-lib). SEULS les formats PNG et JPEG sont autoris√©s pour les logos d'√©cole. Validation c√¥t√© frontend (input accept + v√©rification file.type) ET c√¥t√© backend (multer fileFilter). Message d'erreur bilingue si tentative d'upload GIF: "Format GIF non support√©. Utilisez PNG ou JPEG pour que le logo apparaisse sur les bulletins PDF."
- ABONNEMENTS PARENTS DYNAMIQUES: Site Admin configure les tarifs d'abonnement parent par √©cole via la table `school_parent_pricing`. Deux options principales: Communication (passerelle √©cole-parent) et G√©olocalisation (suivi position enfant). Tarifs configurables: Gratuit/5000/10000/15000 CFA/an. R√©ductions famille automatiques: 2 enfants (-X%), 3+ enfants (-Y%). APIs: `GET/PATCH /api/siteadmin/schools/:id/parent-pricing` (Site Admin), `GET /api/parent/pricing` (prix dynamiques), `POST /api/parent/subscribe` (souscription). Interface ParentSubscription.tsx affiche prix avec prix avec r√©ductions calcul√©s. TOUJOURS r√©cup√©rer les tarifs depuis `school_parent_pricing` pour l'√©cole de l'enfant.
- BULLETINS T1/T2/T3 - CONFIGURATION CSS CRITIQUE: Fichier `client/src/index.css` contient toutes les r√®gles CSS pour les bulletins. NE JAMAIS supprimer ou modifier ces r√®gles sans backup:
  **LAYOUT FLEXBOX ADAPTATIF**:
  - `.bulletin-a4-optimized` : Container principal avec `display: flex`, `flex-direction: column`, `min-height: 297mm`
  - `.bulletin-main-content` : Contenu avec `flex: 1 1 auto` pour remplir l'espace disponible
  - `.grades-table-wrapper` : Tableau notes avec `flex: 1 1 auto` pour s'adapter au nombre de mati√®res
  - `.bulletin-footer-section` : Pied avec `flex: 0 0 auto` et `margin-top: auto` pour rester en bas
  **BILAN ANNUEL T3 VISIBLE**:
  - `.annual-summary-print` : `display: block !important`, `visibility: visible !important` en preview ET print
  - NE JAMAIS ajouter `display: none` sur `.border-orange-300` ou √©l√©ments du bilan annuel
  - R√®gle `.pdf-capture-mode .border-orange-300 { display: none }` INTERDITE
  **A4 CONTAINER**:
  - `.a4-container` : `display: flex`, `flex-direction: column`, `min-height: 297mm`
  - PAS de `overflow: hidden` ou `max-height` restrictifs
  **PDF CAPTURE MODE** (pour html2canvas):
  - `.pdf-capture-mode #print-root` : `width: 794px`, `min-height: 1123px`
  - `.pdf-capture-mode .a4-container` : `max-width: 778px`, `min-height: 1107px`
  - `.pdf-capture-mode .bulletin-a4-optimized` : `min-height: 1100px`, background blanc
  - Polices compactes: headers 7-8px, tables 6-8px, student info 7px
  **PRINT STYLES** (@media print):
  - `.annual-summary-print` : toujours visible avec background blanc
  - Couleurs pr√©serv√©es: `.text-red-600`, `.text-green-700`, `.text-orange-700` avec !important
  - `-webkit-print-color-adjust: exact !important` pour impression couleur
  **COMPOSANT**: `client/src/components/academic/ReportCardPreview.tsx` g√©n√®re les bulletins avec classes CSS appropri√©es

# System Architecture
- **UI/UX Decisions**: The platform features an African-themed, mobile-first, PWA-enabled UI, built using Radix UI, Shadcn/UI, and Tailwind CSS. All alert and confirmation dialogs utilize a `bg-white` background. Student ID cards adhere to a standardized template with color printing, digital signatures, QR codes, and mobile-friendly rendering. The logo display system incorporates a 4-level fallback mechanism, and school logos within PDFs are restricted to PNG and JPEG formats.
- **Technical Implementations**:
    - **Frontend**: Developed with React (TypeScript), using Wouter for routing and TanStack Query for data fetching, and supporting Progressive Web App capabilities.
    - **Backend**: A RESTful API built on Express.js.
    - **Database & ORM**: PostgreSQL, hosted on Neon Serverless, is managed with Drizzle ORM. Strict multi-tenancy is enforced through `user.schoolId`. All data storage modules are database-only, with sandbox data pre-seeded for testing environments.
    - **Authentication**: Session-based authentication is implemented using `express-session` and `Passport.js`, including Firebase Google OAuth. The system supports 8-role-based access control, an Intrusion Detection System (IDS), and multi-role users. Phone numbers serve as the primary unique identifier, with email being optional.
    - **Route Architecture**: Express.js route registration prioritizes internal routes (Settings, API Modules, System Routes) over external routers. Module mappings are strictly separated by dashboard to prevent conflicts.
    - **Cache Management**: `queryClient.ts` employs `serializeQueryKey()` to prevent query key collisions in data fetching.
    - **Document Management**: A centralized system facilitates instant PDF document creation with digital signatures, storing all documents in the `/public/documents/` directory.
    - **Bulletin Generation**: Bulletins are generated using an adaptive flexbox layout defined in `client/src/index.css`, ensuring specific rules for T3 bulletins and overall print quality.
- **Feature Specifications**: Key features include real-time attendance tracking (Present, Late, Absent), flexible timetable management, multi-channel notifications (Email, WhatsApp, PWA), bilingual templates, integrated payment systems, GPS tracking, iCal/ICS export, robust bulk Excel import with immediate data display, Competency-Based Approach (CBA) bulletin generation, and Jitsi Meet integration for online classes. Schools can define custom academic levels. Online course access rules are dynamically determined by subscription types, with UI displaying contextual restrictions. Parent subscriptions are dynamic, configurable by Site Admins, and include automatic family discounts.
- **System Design Choices**: All storage modules rely exclusively on database queries via Drizzle ORM, with no hardcoded or mock data, ensuring maintainability and consistent behavior across environments.

# External Dependencies
- **Neon Database**: Serverless PostgreSQL database.
- **Stripe**: Payment processing.
- **Firebase**: Google OAuth authentication.
- **WhatsApp**: Direct API for notifications.
- **Hostinger**: SMTP services for email notifications.
- **Jitsi Meet**: Video conferencing for online classes.