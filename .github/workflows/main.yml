name: EDUCAFRIC Platform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
      version_name:
        description: 'Version name (e.g., 4.2.1)'
        required: true
        default: '4.2.1'
      version_code:
        description: 'Version code (integer)'
        required: true
        default: '4'

jobs:
  # Code Quality and Testing
  quality:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript check
        run: npx tsc --noEmit --skipLibCheck

      - name: Build frontend
        run: npm run build

      - name: Security audit
        run: npm audit --audit-level=high --production || true

      - name: Project structure validation
        run: |
          echo "=== EDUCAFRIC Project Structure ==="
          echo "Frontend files: $(find client -name "*.tsx" -o -name "*.ts" | wc -l)"
          echo "Backend files: $(find server -name "*.ts" | wc -l)"
          echo "Shared files: $(find shared -name "*.ts" | wc -l)"
          echo "Android files: $(find android -name "*.gradle" -o -name "*.xml" | wc -l)"

  # Android Build (only on manual trigger)
  android:
    name: Android Build
    runs-on: ubuntu-latest
    needs: quality
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        run: |
          sudo mkdir -p /opt/android-sdk
          sudo chown -R $USER:$USER /opt/android-sdk
          
          export ANDROID_HOME=/opt/android-sdk
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          echo "ANDROID_HOME=/opt/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/opt/android-sdk" >> $GITHUB_ENV
          echo "/opt/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "/opt/android-sdk/platform-tools" >> $GITHUB_PATH
          echo "/opt/android-sdk/build-tools/33.0.0" >> $GITHUB_PATH
          
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p $ANDROID_HOME/cmdline-tools/latest
          mv cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
          
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-33"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;33.0.0"

      - name: Install dependencies
        run: |
          npm ci
          npm install -g @capacitor/cli

      - name: Create production environment
        run: |
          echo "VITE_APP_TITLE=EDUCAFRIC" >> .env
          echo "VITE_APP_VERSION=${{ github.event.inputs.version_name || '4.2.1' }}" >> .env
          echo "VITE_ENVIRONMENT=production" >> .env
          echo "VITE_FIREBASE_API_KEY=demo-key" >> .env
          echo "VITE_FIREBASE_PROJECT_ID=educafric-demo" >> .env
          echo "VITE_FIREBASE_APP_ID=demo-app-id" >> .env
          echo "VITE_STRIPE_PUBLIC_KEY=pk_test_demo" >> .env

      - name: Build web application
        run: |
          npm run build
          echo "Web build completed successfully"

      - name: Update Android version
        run: |
          VERSION_NAME="${{ github.event.inputs.version_name || '4.2.1' }}"
          VERSION_CODE="${{ github.event.inputs.version_code || '4' }}"
          
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" android/app/build.gradle
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NAME\"/" capacitor.config.ts
          
          echo "Android version updated to $VERSION_NAME (code: $VERSION_CODE)"

      - name: Sync Capacitor
        run: |
          npx cap sync android
          echo "Capacitor sync completed"

      - name: Grant execute permission
        run: |
          cd android
          chmod +x gradlew

      - name: Create debug keystore
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == ''
        run: |
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      - name: Build Android APK/AAB
        run: |
          cd android
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            ./gradlew bundleRelease --stacktrace
            echo "Release AAB build completed"
          else
            ./gradlew assembleDebug --stacktrace
            echo "Debug APK build completed"
          fi

      - name: List build outputs
        run: |
          echo "Build outputs:"
          find android/app/build/outputs -name "*.apk" -o -name "*.aab" | while read file; do
            echo "$(basename "$file") - $(du -h "$file" | cut -f1)"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: educafric-${{ github.event.inputs.build_type || 'debug' }}-v${{ github.event.inputs.version_name || '4.2.1' }}
          path: |
            android/app/build/outputs/apk/**/*.apk
            android/app/build/outputs/bundle/**/*.aab
          retention-days: 30

      - name: Create build summary
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          VERSION_NAME="${{ github.event.inputs.version_name || '4.2.1' }}"
          VERSION_CODE="${{ github.event.inputs.version_code || '4' }}"
          
          echo "## EDUCAFRIC Android Build v$VERSION_NAME Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION_NAME ($VERSION_CODE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** $BUILD_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features Included" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-role authentication (6 user types)" >> $GITHUB_STEP_SUMMARY
          echo "- Bilingual French/English interface" >> $GITHUB_STEP_SUMMARY
          echo "- Document management with PDF generation" >> $GITHUB_STEP_SUMMARY
          echo "- Geolocation tracking for student safety" >> $GITHUB_STEP_SUMMARY
          echo "- Payment integration with African methods" >> $GITHUB_STEP_SUMMARY
          echo "- SMS/Email notification system" >> $GITHUB_STEP_SUMMARY
          echo "- Portrait-only mobile optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the Actions tab above." >> $GITHUB_STEP_SUMMARY