<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîî PWA Notifications Test - Educafric</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .status { padding: 15px; border-radius: 10px; margin: 10px 0; }
        .success { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        .notifications-list {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        .notification-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4ecdc4;
        }
        #log { max-height: 300px; overflow-y: auto; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî PWA Notifications Test</h1>
        <div id="status" class="status info">Initializing...</div>
        
        <div style="text-align: center;">
            <button onclick="testPermissions()">üîë Request Permission</button>
            <button onclick="fetchNotifications()">üì• Get Notifications</button>
            <button onclick="showTestNotification()">üîî Test Notification</button>
            <button onclick="testCarineNotifications()">üë©‚Äçüíº Show Carine's Notifications</button>
        </div>

        <div class="notifications-list">
            <h3>üìã Notification Log</h3>
            <div id="log"></div>
        </div>

        <div class="notifications-list">
            <h3>üì¨ Retrieved Notifications</h3>
            <div id="notifications"></div>
        </div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const updateStatus = (message, type = 'info') => {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        };

        // Test notification permissions
        async function testPermissions() {
            log('üîë Testing notification permissions...');
            
            if (!('Notification' in window)) {
                updateStatus('‚ùå Browser does not support notifications', 'error');
                log('‚ùå Notification API not supported', 'error');
                return false;
            }

            let permission = Notification.permission;
            log(`Current permission: ${permission}`);

            if (permission === 'default') {
                permission = await Notification.requestPermission();
                log(`Permission after request: ${permission}`);
            }

            if (permission === 'granted') {
                updateStatus('‚úÖ Notification permission granted!', 'success');
                log('‚úÖ Ready to show notifications!', 'success');
                return true;
            } else {
                updateStatus('‚ùå Notification permission denied', 'error');
                log('‚ùå Please allow notifications in browser settings', 'error');
                return false;
            }
        }

        // Show test notification
        async function showTestNotification() {
            if (!await testPermissions()) return;

            log('üîî Showing test notification...');
            
            try {
                const notification = new Notification('üéØ PWA Test Success!', {
                    body: 'PWA notifications are working! Service Worker is active.',
                    icon: '/educafric-logo-128.png',
                    badge: '/educafric-logo-128.png',
                    tag: 'test-notification',
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                });

                notification.onclick = () => {
                    log('‚úÖ Notification clicked!', 'success');
                    notification.close();
                };

                updateStatus('‚úÖ Test notification shown!', 'success');
                log('‚úÖ Test notification displayed', 'success');
            } catch (error) {
                log(`‚ùå Error showing notification: ${error.message}`, 'error');
                updateStatus('‚ùå Failed to show notification', 'error');
            }
        }

        // Fetch notifications from server
        async function fetchNotifications() {
            log('üì• Fetching notifications from server...');
            
            try {
                const response = await fetch('/api/pwa/notifications/missed', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const notifications = await response.json();
                log(`üì• Retrieved ${notifications.length} notifications`, 'success');
                
                const notifDiv = document.getElementById('notifications');
                notifDiv.innerHTML = '';
                
                notifications.forEach((notif, index) => {
                    notifDiv.innerHTML += `
                        <div class="notification-item">
                            <strong>üì¨ ${notif.title}</strong><br>
                            ${notif.message}<br>
                            <small>ID: ${notif.id} | Type: ${notif.type} | Time: ${new Date(notif.timestamp).toLocaleString()}</small>
                        </div>
                    `;
                });
                
                updateStatus(`‚úÖ Found ${notifications.length} notifications`, 'success');
                return notifications;
            } catch (error) {
                log(`‚ùå Error fetching notifications: ${error.message}`, 'error');
                updateStatus('‚ùå Failed to fetch notifications', 'error');
                return [];
            }
        }

        // Test Carine's notifications specifically
        async function testCarineNotifications() {
            if (!await testPermissions()) return;
            
            log('üë©‚Äçüíº Testing Carine Commercial notifications...');
            
            try {
                const notifications = await fetchNotifications();
                
                for (let i = 0; i < notifications.length && i < 3; i++) {
                    const notif = notifications[i];
                    setTimeout(() => {
                        const notification = new Notification(`üè¢ ${notif.title}`, {
                            body: notif.message,
                            icon: '/educafric-logo-128.png',
                            badge: '/educafric-logo-128.png',
                            tag: `carine-${notif.id}`,
                            requireInteraction: true,
                            vibrate: [100, 50, 100, 50, 100],
                            data: { 
                                userId: notif.userId, 
                                type: notif.type,
                                profile: 'Commercial'
                            }
                        });
                        
                        notification.onclick = () => {
                            log(`‚úÖ Clicked: ${notif.title}`, 'success');
                            notification.close();
                        };
                        
                        log(`üîî Shown: ${notif.title}`, 'success');
                    }, i * 1500);
                }
                
                updateStatus('‚úÖ Carine Commercial notifications shown!', 'success');
            } catch (error) {
                log(`‚ùå Error with Carine notifications: ${error.message}`, 'error');
            }
        }

        // Auto-initialize on page load
        window.addEventListener('load', async () => {
            log('üöÄ PWA Notification Test Page Loaded');
            log('üì± Browser: ' + navigator.userAgent.split(' ').slice(-2).join(' '));
            log('üîß Service Worker support: ' + ('serviceWorker' in navigator ? 'Yes' : 'No'));
            log('üîî Notification support: ' + ('Notification' in window ? 'Yes' : 'No'));
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        log('‚úÖ Service Worker is registered', 'success');
                        updateStatus('üîß Service Worker active - Ready for notifications!', 'success');
                    } else {
                        log('‚ö†Ô∏è Service Worker not registered', 'error');
                        updateStatus('‚ö†Ô∏è Service Worker not found', 'error');
                    }
                } catch (error) {
                    log(`‚ùå SW check error: ${error.message}`, 'error');
                }
            }
            
            // Auto-request permissions
            await testPermissions();
        });
    </script>
</body>
</html>