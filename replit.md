# Overview
Educafric is a mobile-first, bilingual Progressive Web App (PWA) EdTech platform designed for African educational institutions. It offers comprehensive tools for academic administration, communication, and financial management, built on a Competency-Based Approach (CBA). The platform's vision is to enhance educational experiences, streamline administrative tasks, and become a leading, culturally relevant EdTech solution across Africa.

# User Preferences
- Module FunctionalTeacherAssignments.tsx enti√®rement bilingue (formulaire, labels, boutons, toasts). Onglets responsives (flex-col sm:flex-row, min-h-[44px]). Profils modifiables pour Teacher/Parent/Commercial via PUT endpoints. Fix WhatsApp password recovery (u.phone pas u.phoneNumber). ParentSubscription avec gestion erreurs. FIX CRITIQUE: fastModuleLoader.ts ligne 100 mapping 'subscription' corrig√© vers ParentSubscription (pas SubscriptionStatusCard).
- Modules TeacherAbsenceDeclaration.tsx (enseignant) et TeacherAbsenceManager.tsx (directeur) enti√®rement bilingues. Fonction `translateReason()` pour convertir les codes motifs en texte lisible. Codes motifs: maladie/Illness, urgence-familiale/Family emergency, rendez-vous-medical/Medical appointment, formation/Professional training, conges/Leave, autre/Other. Aussi supporte: medical/Personal, personal/Personal, official/Official, emergency/Emergency, training/Training, other/Other. Labels traduits: "Motif:"/"Reason:", "Parents notifi√©s"/"Parents notified", "√âl√®ve notifi√©s"/"Students notified", "R√©solue"/"Resolved", "Rempla√ßant"/"Substitute", "En attente"/"Pending". Dates localis√©es fr-FR/en-US.
- Les bases de donn√©es de d√©veloppement et production sont COMPL√àTEMENT S√âPAR√âES avec Z√âRO r√©plication automatique. Toute modification de donn√©es utilisateur (mot de passe, r√¥les, affiliations) DOIT √™tre ex√©cut√©e dans LES DEUX environnements via le panneau Database. Pour modifier la production: Database > Production database > My Data > activer toggle "Edit" > ex√©cuter SQL.
- Comptes sandbox et @test.educafric.com sont d√©finitivement exempt√©s de TOUTES restrictions premium. Patterns d'exemption incluent @test.educafric.com, sandbox@, demo@, test@, .sandbox@, .demo@, .test@. Exemptions couvrent : restrictions de fonctionnalit√©s, limites freemium, v√©rifications d'abonnement. Logs automatiques : [PREMIUM_EXEMPT] et [LIMITS_EXEMPT] pour tracking.
- Syst√®me de mapping des modules r√©organis√© avec s√©paration stricte par dashboard. Validation automatique des mappings pour d√©tecter les conflits et doublons. Le module 'students' DOIT pointer vers FunctionalDirectorStudentManagement. Structure organis√©e : Director ‚Üí Commercial ‚Üí Parent ‚Üí Student ‚Üí Teacher ‚Üí Shared. NE JAMAIS m√©langer les mappings de modules entre dashboards diff√©rents.
- Probl√®me de conflits entre routes settings r√©solu par r√©organisation de l'ordre d'enregistrement. Routes settings d√©finies AVANT routers externes. Ordre prioritaire : Settings ‚Üí API Modules ‚Üí System Routes ‚Üí Services. Toujours maintenir l'ordre d'enregistrement des routes.
- Email est maintenant OPTIONNEL, le num√©ro de t√©l√©phone est l'identifiant principal unique. La colonne `email` dans `users` est nullable. Validation Zod et Passport strategy adapt√©es pour accepter email optionnel et t√©l√©phone requis (min 10 caract√®res). Le num√©ro de t√©l√©phone DOIT √™tre unique et valide (min 10 caract√®res).
- √âcoles d√©finissent leurs propres niveaux acad√©miques via la table `school_levels` et l'API CRUD d√©di√©e `/api/director/school-levels`. Une interface UI est disponible. L'import de classes valide les niveaux contre les niveaux d√©finis par l'√©cole avec normalisation robuste et messages d'erreur claires. √âcoles DOVENT d'abord d√©finir leurs niveaux dans Param√®tres > Acad√©mique avant d'importer les classes.
- Donn√©es import√©es apparaissent IMM√âDIATEMENT sans rafra√Æchissement manuel gr√¢ce √† double invalidation + refetch explicite dans ExcelImportButton. Tous les modules concern√©s (Classes, Enseignants, √âl√®ves, Emploi de temps, Salles) b√©n√©ficient du rafra√Æchissement automatique. Tout nouveau module utilisant ExcelImportButton DOIT passer les queryKeys appropri√©es dans la prop `invalidateQueries`.
- Correction syst√©matique de l'utilisation de `user.schoolId` (valeur correcte) au lieu de `user.school_id` (toujours undefined) dans TOUTES les APIs Director. Les √©coles voient maintenant LEURS propres donn√©es. TOUJOURS utiliser `user.schoolId` (avec majuscule I) pour isolation multi-tenant, JAMAIS `user.school_id`.
- TOUS les modules storage (StudentStorage, TimetableStorage, BulletinStorage, ClassStorage, etc.) utilisent UNIQUEMENT des requ√™tes database via Drizzle ORM. Z√âRO donn√©e hardcod√©e/mock dans le code storage. Les √©coles sandbox (IDs 1-6, 15) re√ßoivent leurs donn√©es d√©mo via pre-seeding dans la database r√©elle avec le script `server/scripts/seedSandboxData.ts` (idempotent, peut √™tre r√©ex√©cut√©). Cette architecture garantit: code maintenable, comportement identique pour tous, et donn√©es d√©mo persistantes dans la DB. NE JAMAIS ajouter de mock data arrays dans les storage modules - toujours utiliser database queries.
- Impossible d'ajouter un utilisateur existant comme Teacher est r√©solu. Syst√®me multirole complet avec table `role_affiliations` et champs `secondaryRoles`, `activeRole`, `roleHistory`. D√©tection automatique des utilisateurs existants par email OU t√©l√©phone avant cr√©ation. Ajout de r√¥le secondaire et affiliation si utilisateur existe. Toujours v√©rifier utilisateurs existants par email/phone AVANT cr√©ation dans ANY API de cr√©ation utilisateur.
- Le nom d'√©cole √©dit√© dans le profil Director se sauve maintenant correctement. L'endpoint PUT `/api/director/settings` met √† jour le champ `name` dans la table `schools` quand `schoolName` est modifi√©. Toute modification de donn√©es √©cole (nom, adresse, etc.) dans le profil Director DOIT mettre √† jour la table `schools`, pas seulement la table `users`.
- TOUS les dialogs d'alerte/confirmation (DeleteConfirmationDialog et autres AlertDialogContent) DOVENT avoir un fond blanc permanent avec la classe `bg-white`. Ceci garantit une lisibilit√© optimale peu importe le th√®me actif. Le composant `DeleteConfirmationDialog` a √©t√© mis √† jour avec `<AlertDialogContent className="bg-white">`. Tout nouveau dialog d'alerte DOIT suivre ce standard.
- L'endpoint `/api/director/students` a √©t√© corrig√© pour retourner UNIQUEMENT les mock students pour les utilisateurs sandbox (email contenant @test.educafric.com, @educafric.demo, sandbox@, demo@, .sandbox@, .demo@, .test@). Les √©coles r√©elles re√ßoivent UNIQUEMENT les √©tudiants de la base de donn√©es via une requ√™te Drizzle. JAMAIS de mock data pour les √©coles r√©elles.
- Le module Fiche Scolaire (Mastersheet) dans Gestion Acad√©mique utilise maintenant UNIQUEMENT des donn√©es database via l'endpoint `/api/director/bulletins/list`. Cet endpoint interroge la table `bulletinComprehensive` avec isolation multi-tenant stricte (filtre par `schoolId`, `classId`, et `term`). L'affichage inclus : informations r√©elles de l'√©cole depuis `/api/director/settings`, liste des bulletins cr√©√©s avec noms d'√©l√®ves/moyennes/rangs/codes de v√©rification, et ent√™te d'impression bilingue format minist√®re (R√âPUBLIQUE DU CAMEROUN / REPUBLIC OF CAMEROON) avec logo de l'√©cole et d√©l√©gations officielles. Z√âRO mock data, tout vient de la database.
- Les modules enseignant r√©cup√®rent maintenant les mati√®res/classes depuis `teacherSubjectAssignments` (module "Mes Classes") et NON depuis `timetables`. Endpoints modifi√©s:
    - `/api/teacher/bulletin/class-subjects/:classId` - R√©cup√®re UNIQUEMENT depuis `teacherSubjectAssignments` pour afficher automatiquement le nom de l'enseignant + mati√®re assign√©e dans "Notes par mati√®re"
    - `/api/teacher/timetable` - R√©cup√®re depuis `timetables` ET `teacherSubjectAssignments`, retourne `assignedClasses` et `assignedSubjects` dans la r√©ponse
    - La source principale pour les mati√®res assign√©es est TOUJOURS `teacherSubjectAssignments`, pas `timetables`
- Le module Pr√©sences enseignant a maintenant 3 options de statut au lieu de 2: Pr√©sent (vert), Retard (orange), Absent (rouge). Chaque √©l√®ve a 3 boutons cliquables avec ic√¥nes (CheckCircle, Clock, XCircle). POST `/api/teacher/attendance` et GET `/api/profile` endpoints ajout√©s.
- La table pour les inscriptions d'√©l√®ves aux classes est `enrollments`, PAS `class_enrollment`. Structure: `id`, `student_id`, `academic_year_id`, `enrollment_date`, `status`. TOUJOURS utiliser `enrollments` dans les requ√™tes SQL pour r√©cup√©rer les √©l√®ves d'une classe.
- Pour lier parents et √©l√®ves, utiliser la table `parent_student_relations` (colonnes: `id`, `parent_id`, `student_id`, `relationship`, `is_primary`, `created_at`). NE JAMAIS chercher un `parent_id` dans la table `users` - cette colonne n'existe pas. Exemple SQL: `SELECT parent_id FROM parent_student_relations WHERE student_id FROM (...)`.
- L'endpoint POST `/api/teacher/attendance` accepte les deux formats: `student.id` OU `student.studentId` dans le tableau `students`. Le code utilise `const studentIdValue = student.id || student.id` pour compatibilit√© maximale.
- Syst√®me de notifications automatiques avec 3 canaux: Email (Hostinger SMTP), WhatsApp (Direct API), PWA (Push notifications). Configuration dans `[AUTO_NOTIFICATIONS]`. √âv√©nements notifi√©s: attendance (absences/retards), grades, payments, geolocation, onlineClasses, subscriptions.
- Module TeacherTimetable simplifi√© - onglets "Demandes" et "R√©ponses Admin" supprim√©s. Les enseignants voient uniquement leur planning sans workflow de demande de changement.
- Le design de la carte d'identit√© √©tudiant (StudentIDCard.tsx) est le mod√®le OFFICIEL pour TOUTES les √©coles Educafric. Fonctionnalit√©s: impression mobile-friendly (d√©tection automatique smartphone + instructions PDF), impression COULEUR garantie (`-webkit-print-color-adjust: exact !important`), signature digitale du directeur depuis `/api/signatures/principal`, QR code de v√©rification, format carte cr√©dit (85.6mm x 54mm), recto/verso avec contacts urgence. Sur mobile: approche blob URL + fallback iframe avec un bouton fermer. TOUJOURS utiliser ce composant pour les cartes d'identit√©.
- R√àGLE M√âTI√àRE - Les √©l√®ves peuvent ENVOYER des messages UNIQUEMENT √† leurs parents, mais peuvent RECEVOIR des messages de TOUS les profils (parents, enseignants, directeur, √©cole). L'endpoint `POST /api/student/messages/parent` est r√©serv√© aux envois vers envois vers parents li√©s via `parent_student_u_relations`. L'endpoint `GET /api/student/messages` retourne TOUS les messages re√ßus. Interface avec onglets de filtrage (Tous, Parents, Enseignants, √âcole) et bouton de r√©ponse visible uniquement pour messages parents.
- ALWAYS consolidate ALL dashboards (Teacher, Student, Parent, Commercial, SiteAdmin) when making changes.
- APPLICATION MOBILE ANDROID: Les profils Commercial, SiteAdmin et Admin sont BLOQU√âS sur l'app mobile. Seuls Director, Teacher, Student, Parent peuvent se connecter via l'app. D√©tection via header `X-Educafric-Platform: android` ou User-Agent contenant `Capacitor` ou `EducafricApp`. Message d'erreur bilingue affich√©: "Ce profil n'est pas disponible sur l'application mobile".
- NEVER make partial updates to only some dashboards.
- ALWAYS preserve button functionality when making changes - buttons must remain functional.
- DOCUMENTS MUST APPEAR INSTANTLY: User is frustrated that document creation takes hours - streamline to work immediately.
- ALL documents MUST be placed in `/public/documents/` directory with lowercase kebab-case naming.
- Use consolidated EDUCAFRIC system for document creation:
    1. Create specialized PDF generator method in `server/services/pdfGenerator.ts`.
    2. Add document to commercial docs list in `server/routes.ts` (both view and download routes).
    3. Create HTML version in `/public/documents/` for web viewing.
    4. Update alphabetical index in `00-index-documents-alphabetique.html`.
    5. Test via API routes `/api/commercial/documents/{id}/download` and direct HTML access.
- Le g√©n√©rateur PDF (`pdfGenerator.ts`) utilise un syst√®me de r√©solution hybride pour trouver les logos d'√©cole. Chemins test√©s: 1) Chemin normalis√©, 2) `public/` + chemin, 3) `public/uploads/logos/` + nom fichier, 4) Chemin relatif depuis projet. Logs d√©taill√©s: `[PDF_LOGO] üîç Searching logo...`. Le formulaire de bulletin affiche un aper√ßu du logo + option d'upload manuel dans la section "Informations √âcole". Les logos sont stock√©s dans `public/uploads/logos/` avec noms format `school-{id}-{timestamp}.{ext}`.
- Le format GIF n'est PAS support√© par le g√©n√©rateur PDF (pdf-lib). SEULS les formats PNG et JPEG sont autoris√©s pour les logos d'√©cole. Validation c√¥t√© frontend (input accept + v√©rification file.type) ET c√¥t√© backend (multer fileFilter). Message d'erreur bilingue si tentative d'upload GIF: "Format GIF non support√©. Utilisez PNG ou JPEG pour que le logo apparaisse sur les bulletins PDF."
- Site Admin configure les tarifs d'abonnement parent par √©cole via la table `school_parent_pricing`. Deux options principales: Communication (passerelle √©cole-parent) et G√©olocalisation (suivi position enfant). Tarifs configurables: Gratuit/5000/10000/15000 CFA/an. R√©ductions famille automatiques: 2 enfants (-X%), 3+ enfants (-Y%). APIs: `GET/PATCH /api/siteadmin/schools/:id/parent-pricing` (Site Admin), `GET /api/parent/pricing` (prix dynamiques), `POST /api/parent/subscribe` (souscription). Interface ParentSubscription.tsx affiche prix avec prix avec r√©ductions calcul√©s. TOUJOURS r√©cup√©rer les tarifs depuis `school_parent_pricing` pour l'√©cole de l'enfant.
- MODULES COMMERCIAL NETTOY√âS: Tous les modules du dashboard Commercial utilisent maintenant React Query avec vraies APIs au lieu de mock data. Fichiers corrig√©s: MySchools.tsx, CallsAppointments.tsx, Messages.tsx. √âtats de chargement bilingues avec spinners. √âtats vides bilingues avec ic√¥nes (Building2 16x16 pour √©coles, Phone/Calendar pour appels, MessageSquare pour messages). APIs retournent tableaux vides avec TODO pour future impl√©mentation database. Noms fictifs supprim√©s: Jean Mbaku, Marie Atangana, Paul Mvondo, Marc Dupont, Sophie Martin, Sarah Nkomo, Paul Mbarga, Marie Fotso.
- PATTERN BILINGUE STANDARD: Utiliser hook `useLanguage()` avec objet `t` contenant `fr` et `en`. Pour √©tats vides: Card avec ic√¥ne (className="w-16 h-16 text-gray-300 mx-auto mb-4"), message FR/EN centr√©, texte gris. Pour chargement: Spinner avec texte "Chargement..."/"Loading...". Format: `{language === 'fr' ? 'Texte FR' : 'English text'}`.
- R√âDUCTIONS FAMILIALES DYNAMIQUES PAR √âCOLE: Le syst√®me de r√©duction pour parents avec plusieurs enfants est ENTI√àREMENT dynamique et configurable par √©cole via Site Admin. Table `school_parent_pricing` contient les champs `discount_2_children` et `discount_3plus_children` (valeurs par d√©faut: 20% et 40%). Endpoint `/api/parent/pricing` r√©cup√®re les r√©ductions depuis l'√©cole des enfants du parent. Frontend `ParentSubscription.tsx` utilise `pricing.discounts.twoChildren` et `pricing.discounts.threePlusChildren` de l'API. Site Admin modifie via `PATCH /api/siteadmin/schools/:id/parent-pricing` avec `discount2Children` et `discount3PlusChildren`. NE JAMAIS hardcoder les pourcentages de r√©duction - toujours utiliser les valeurs de la database.
- Fichier `client/src/index.css` contient toutes les r√®gles CSS pour les bulletins. NE JAMAIS supprimer ou modifier ces r√®gles sans backup:
    - LAYOUT FLEXBOX ADAPTATIF:
        - `.bulletin-a4-optimized` : Container principal avec `display: flex`, `flex-direction: column`, `min-height: 297mm`
        - `.bulletin-main-content` : Contenu avec `flex: 1 1 auto` pour remplir l'espace disponible
        - `.grades-table-wrapper` : Tableau notes avec `flex: 1 1 auto` pour s'adapter au nombre de mati√®res
        - `.bulletin-footer-section` : Pied avec `flex: 0 0 auto` et `margin-top: auto` pour rester en bas
    - BILAN ANNUEL T3 VISIBLE:
        - `.annual-summary-print` : `display: block !important`, `visibility: visible !important` en preview ET print
        - NE JAMAIS ajouter `display: none` sur `.border-orange-300` ou √©l√©ments du bilan annuel
        - R√®gle `.pdf-capture-mode .border-orange-300 { display: none }` INTERDITE
    - A4 CONTAINER:
        - `.a4-container` : `display: flex`, `flex-direction: column`, `min-height: 297mm`
        - PAS de `overflow: hidden` ou `max-height` restrictifs
    - PDF CAPTURE MODE (for html2canvas):
        - `.pdf-capture-mode #print-root` : `width: 794px`, `min-height: 1123px`
        - `.pdf-capture-mode .a4-container` : `max-width: 778px`, `min-height: 1107px`
        - `.pdf-capture-mode .bulletin-a4-optimized` : `min-height: 1100px`, background blanc
        - Polices compactes: headers 7-8px, tables 6-8px, student info 7px
    - PRINT STYLES (@media print):
        - `.annual-summary-print` : toujours visible avec background blanc
        - Couleurs pr√©serv√©es: `.text-red-600`, `.text-green-700`, `.text-orange-700` avec !important
        - `-webkit-print-color-adjust: exact !important` pour impression couleur
    - COMPOSANT: `client/src/components/academic/ReportCardPreview.tsx` g√©n√®re les bulletins avec classes CSS appropri√©es
- DESIGN MODERNE JANVIER 2026: Refonte UI compl√®te avec th√®me violet moderne (#7C5CFC). Composants cl√©s:
    - `UnifiedIconDashboard.tsx`: Grille principale d'ic√¥nes avec 3 colonnes mobile / 4-6 colonnes desktop
    - `DashboardNavbar.tsx`: Barre de navigation avec titre, sous-titre, langue, notifications, d√©connexion
    - `MobileIconTabNavigation.tsx`: Navigation par onglets sur mobile
    - `ResponsiveTabs.tsx`: Composant r√©utilisable pour onglets responsifs
- PATTERN ONGLETS RESPONSIFS (STANDARD OBLIGATOIRE):
    - TabsList: `grid w-full grid-cols-X h-auto p-1.5 bg-[#F3F5F7] rounded-xl gap-1`
    - TabsTrigger: `flex items-center justify-center gap-2 min-h-[44px] px-2 py-2 text-xs sm:text-sm data-[state=active]:bg{white] data-[state=active]:text-[#7C5CFC] data-[state=active]:shadow-sm`
    - Labels: `<span className="hidden sm:inline truncate">{label}</span>` (ic√¥nes seules sur mobile, ic√¥nes+texte sur desktop)
    - Ic√¥nes: `className="w-4 h-4 flex-shrink-0"`
    - Modules mis √† jour: TeacherAbsenceManager, TeacherOnlineClasses, StudentCommunications, FunctionalParentProfile, et 10+ autres
- TITRE DASHBOARD NON DUPLIQU√â: Le titre et sous-titre du dashboard apparaissent UNIQUEMENT dans DashboardNavbar. NE JAMAIS ajouter de section titre dans le contenu principal (UnifiedIconDashboard). Le composant affiche directement la grille d'ic√¥nes sans titre r√©p√©t√©.
- COULEURS IC√îNES PR√âSERV√âES: Les ic√¥nes de modules conservent leurs couleurs distinctives originales (vert, violet, orange, rose, etc.). NE JAMAIS forcer toutes les ic√¥nes en violet - chaque module a sa couleur identitaire.
- IMPORT EXCEL ENSEIGNANTS: L'import bulk des enseignants utilise le mot de passe par d√©faut `Educafric2024!` pour tous les nouveaux comptes. Champs import√©s: firstName, lastName, email, phone, gender, matricule, dateOfBirth, placeOfBirth, teachingSubjects. IMPORTANT: Le r√¥le DOIT √™tre `'Teacher'` avec T majuscule (pas 'teacher' minuscule) car l'API `/api/director/teachers` filtre avec `eq(users.role, 'Teacher')`. Strat√©gie de d√©duplication: `ON CONFLICT DO NOTHING` sur email et phone. Les enseignants peuvent se connecter avec email OU t√©l√©phone + mot de passe `Educafric2024!` et doivent changer leur mot de passe apr√®s premi√®re connexion.
- S√âCURIT√â ARRAYS API: Toujours v√©rifier que les donn√©es retourn√©es par les APIs sont des tableaux avant d'appeler `.map()`. Pattern obligatoire: `const safeData = Array.isArray(data) ? data : [];` AVANT tout `.map()`, `.filter()`, `.length`. Exemple dans FunctionalTeacherAttendance.tsx: `const safeClassStudents = Array.isArray(classStudents) ? classStudents : [];`. Ceci √©vite les erreurs "X.map is not function" quand l'API retourne undefined ou un objet au lieu d'un tableau.
- Z√âRO DONN√âES FICTIVES DANS MODULES ENSEIGNANT: Le module CreateEducationalContent.tsx utilise UNIQUEMENT les mati√®res et classes r√©elles assign√©es √† l'enseignant. Sources de donn√©es: table `timetables` (emploi du temps) et table `teacherSubjectAssignments` (affectations). Si listes vides = enseignant sans emploi de temps ou affectations. Le directeur DOIT cr√©er un emploi de temps ou assigner des mati√®res pour que l'enseignant voie ses vraies classes. NE JAMAIS ajouter de fallback vers donn√©es fictives (Math√©matiques, 6√®me, etc.).
- MODULE G√âOLOCALISATION DIRECTEUR SUPPRIM√â: Le fichier `GeolocationManagement.tsx` du tableau de bord Directeur a √©t√© SUPPRIM√â car les APIs backend `/api/director/geolocation/*` ont √©t√© d√©commissionn√©es depuis longtemps. R√©f√©rences retir√©es de: DirectorDashboard.tsx (eventTypes, traductions), InteractiveSchoolConfigurationGuide.tsx (√©tape configuration). SEULS les modules Parent (ParentGeolocation.tsx) et √âl√®ve (StudentGeolocation.tsx) restent fonctionnels avec les APIs `/api/geolocation/*`. NE JAMAIS recr√©er de module g√©olocalisation Directeur sans d'abord impl√©menter les APIs backend.
- S√âLECTION CLASSES ABSENCE ENSEIGNANT: Dans le module TeacherAbsenceDeclaration.tsx, les classes s√©lectionn√©es ont un style visuel distinctif: `ring-2 ring-[#7C5CFC] ring-offset-2 bg-[#7C5CFC] shadow-md`. Ceci aide les enseignants assign√©s √† plusieurs √©coles √† identifier clairement les classes concern√©es par leur absence. Les classes non s√©lectionn√©es ont un hover violet subtil (`hover:border-[#7C5CFC] hover:text-[#7C5CFC]`).
- PARENT API RESPONSE STRUCTURE: Les endpoints parent retournent un objet `{success: boolean, children/homework/data: [...]}` et NON un tableau direct. Dans les composants React Query, TOUJOURS extraire les donn√©es: `const children = childrenResponse?.children || [];`. Endpoints concern√©s: `/api/parent/children`, `/api/parent/children/homework`. Pattern obligatoire dans useQuery: `queryFn: async () => { const data = await response.json(); return data.children || []; }`.
- QUICK ACTIONS PARENT NAVIGATION: Les Actions Rapides dans FunctionalParentChildren.tsx utilisent l'√©v√©nement `switchModule` pour naviguer vers les modules. Format: `window.dispatchEvent(new CustomEvent('switchModule', { detail: { moduleId: 'parent-homework' } }));`. Mapping des actions: Notes‚Üí`parent-homework`, Pr√©sences‚Üí`parent-attendance`, Messages‚Üí`parent-messages`, G√©olocalisation‚Üí`geolocation`. UnifiedIconDashboard √©coute cet √©v√©nement et switch le module. NE JAMAIS utiliser les anciens √©v√©nements (`switchToGrades`, `switchToAttendance`, etc.) - ils ne sont plus √©cout√©s.
- MODULE PR√âSENCES PARENT (FunctionalParentAttendance.tsx): Interface bilingue avec demande d'excuse. L'interface Child accepte les champs `class`/`className` et `school`/`schoolName` pour compatibilit√©. Le Select affiche: `{child.firstName} {child.lastName} - {child.class || child.className} ({child.school || child.schoolName})`. L'endpoint `/api/parent/attendance/excuse` existe dans `server/routes/api/parent.ts` (ligne 936) et envoie des notifications √† l'√©cole (teacher, admin, director, SMS si configur√©). La demande d'excuse affiche le nombre d'enfants trouv√©s dans le label pour debug.
- MODULE TROUVER MES PARENTS (FindParentsModule.tsx): Interface simplifi√©e pour les √©l√®ves. Formulaire avec SEULEMENT: email OU t√©l√©phone + type de relation (Parent/Tuteur). PAS de champ message. Le dropdown "Type de relation" affiche une seule option "Parent/Tuteur" pour nouvelles demandes, mais les traductions conservent `emergency_contact` pour afficher les anciennes connexions.
- CONNEXION √âL√àVE-PARENT - WORKFLOW COMPLETS:
    - **√âl√®ve initie la demande**: Module `FindParentsModule.tsx` permet √† l'√©l√®ve de chercher un parent par email ou t√©l√©phone. L'API `POST /api/student-parent/connections` v√©rifie que le parent existe, bloque les doublons (d√©j√† connect√© ou en attente), et cr√©e un enregistrement dans `parent_student_relations` avec `status='pending'` et `requestedBy='student'`. Une notification est cr√©√©e pour le parent.
    - **Parent re√ßoit et r√©pond**: Module `FamilyConnections.tsx` affiche les demandes en attente dans une section orange avec boutons Approuver (vert) / Refuser (rouge). L'API `PATCH /api/family/connections/:connectionId/respond` valide que l'utilisateur est le parent concern√©, met √† jour le statut (`approved` ou `rejected`), et cr√©e une notification pour l'√©l√®ve.
    - **√âtats possibles**: `pending` ‚Üí `approved` (connexion active avec `approvedAt`) ou `rejected` (√©l√®ve peut r√©essayer plus tard). Les connexions approuv√©es apparaissent dans la liste principale "Mes enfants".
    - **Colonnes DB**: Table `parent_student_relations` contient `status` (pending/approved/rejected), `requestedBy` (student/parent), `verificationCode`, `approvedAt`.
- QR CODE G√âN√âRATION - FIX CRITIQUE: L'API `/api/student/generate-qr` retourne `shareUrl` (URL string) et `qrData` (objet JSON). Le frontend DOIT utiliser `data.shareUrl` pour g√©n√©rer le QR code, PAS `data.qrData` (qui est un objet et cause l'erreur "Invalid data"). L'API g√©n√®re dynamiquement l'URL avec le host de la requ√™te: `${protocol}://${host}/parent-connect?student=${user.id}&code=${connectionId}`. Pattern frontend: `const apiMagicLink = data.shareUrl || data.dynamicLink || fallbackUrl;`
- PI√àCES JOINTES DEVOIRS: Les enseignants peuvent attacher des fichiers aux devoirs. Architecture compl√®te:
    - Upload endpoint: `POST /api/upload/homework` - Multer avec memoryStorage, limite 10MB, formats autoris√©s: image/jpeg, image/png, image/gif, image/webp, application/pdf. Fichiers stock√©s dans `/public/uploads/homework/` avec noms format `homework-{userId}-{timestamp}-{uniqueId}.{ext}`.
    - Schema: Table `homework` contient colonne `attachments` (JSONB) - Array de `{url, filename, mimetype, size}`.
    - Cr√©ation devoir: `POST /api/teacher/homework` accepte `attachments` dans le body et les sauvegarde dans la colonne JSONB.
    - Acc√®s √©l√®ves: `GET /api/student/homework` retourne les devoirs avec champ `attachments` contenant les pi√®ces jointes de l'enseignant.
    - Acc√®s parents: `GET /api/parent/children/homework` - Nouvel endpoint qui r√©cup√®re les devoirs de tous les enfants du parent (MULTI-√âCOLE) via `parent_student_relations` ‚Üí `enrollments` ‚Üí `homework`. Retourne aussi le statut de soumission par enfant. Pas de filtre par √©cole - agr√®ge TOUS les enfants.
    - Notifications cr√©ation devoir: Notifications automatiques aux √©l√®ves (Email, WhatsApp, PWA) lors de cr√©ation de devoir. Rappels automatiques √† 7h, 12h, 18h avant √©ch√©ance via `[HOMEWORK_REMINDER]` service.
    - Notifications soumission devoir: Quand un √©l√®ve soumet son devoir (`POST /api/student/homework/:id/submit`), notification automatique envoy√©e aux parents via: 1) PWA notification (table `notifications`), 2) Email via autoNotificationService, 3) WhatsApp via autoNotificationService. L'enseignant re√ßoit aussi une notification.
    - Frontend Parent: Module ParentChildrenHomework.tsx avec onglets Tous/En attente/Rendus, affichage pi√®ces jointes, statut soumission par enfant.
- Le logo de l'√©cole DOIT √™tre r√©cup√©r√© depuis `/api/director/settings` (champ `school.logoUrl` ou `profile.logoUrl`) et stock√© dans `formData.schoolLogoUrl`. Tous les endroits g√©n√©rant des bulletins DOIVENT utiliser `formData.schoolLogoUrl` au lieu de donn√©es hardcod√©es. Le champ database est `schools.logoUrl` (pas `logo`). L'endpoint `PUT /api/school/logo` utilise `db.update(schools).set({ logoUrl: ... })` pour persister.
- R√àGLES D'ACC√àS CRITIQUES POUR MODULE COURS EN LIGNE:
    - INTERFACE VISIBLE POUR TOUS: TOUS les enseignants DOIVENT voir l'interface compl√®te avec les 3 onglets ("Mes Cours", "Sessions √† Venir", "Cr√©er un Cours") - JAMAIS cacher les onglets bas√© sur le statut d'abonnement.
    - LOGIQUE FRONTEND: La condition `!hasPersonalSubscription` affiche les onglets avec restrictions (prompts d'achat). La condition `hasPersonalSubscription` affiche l'interface compl√®te avec cr√©ation de cours.
    - 3 NIVEAUX D'ACC√àS:
        1) Abonnement Personnel (activationType='teacher') ‚Üí Acc√®s complet, cr√©ation de cours ind√©pendants
        2) Activation √âcole (activationType='school') ‚Üí Sessions assign√©es uniquement, prompt achat pour cr√©er cours
        3) Sans Abonnement (activationType=null) ‚Üí Interface visible, tous les boutons de cr√©ation montrent prompt d'achat
    - COURS LI√â √Ä UNE √âCOLE NON ACTIV√â: Si `!hasSchoolAccess`, afficher un avertissement orange expliquant: "Module non activ√© par votre √©cole" avec 2 options: a) Demander au directeur de contacter Educafric, b) Acheter un abonnement personnel.
    - BACKEND: `onlineClassAccessService.checkAccess()` retourne TOUJOURS `allowed: true` pour les enseignants, avec flags `canCreateCourses` et `canStartSession` pour contr√¥ler les actions.
    - MULTI-R√îLE: V√©rifier `effectiveRole = user.activeRole || user.role` pour compatibilit√© Parent‚ÜíTeacher.
    - NE JAMAIS: Cacher les onglets de l'interface bas√© sur `hasPersonalSubscription` ou `hasSchoolAccess` - toujours montrer l'interface compl√®te avec restrictions contextuelles.
    - DIRECTEUR - AVERTISSEMENT ACTIVATION: Dans OnlineClassesManager.tsx (director), v√©rifier `isSchoolActivated` via `/api/online-class-activations/school-status`. Si `!isSchoolActivated`, afficher un bandeau orange avec bouton WhatsApp pour contacter Educafric.
    - BOUTON WHATSAPP: Tous les boutons "Contacter Educafric" doivent ouvrir WhatsApp (pas email) avec message pr√©-rempli. NUM√âRO OFFICIEL: `237656200472`. Format: `https://wa.me/237656200472?text=...`. NE JAMAIS utiliser le num√©ro placeholder `237699999999`.

# System Architecture
- **UI/UX Decisions**: Mobile-first PWA with a modern purple (#7C5CFC) African theme, using Radix UI, Shadcn/UI, and Tailwind CSS. All alert/confirmation dialogs must have a `bg-white` background. Student ID cards are standardized for official use, supporting mobile-friendly, color-adjusted printing, credit card dimensions, digital principal signatures, and QR code verification. A 4-level logo fallback system is implemented, supporting only PNG/JPEG for PDF school logos. Online course interfaces are always visible to all teachers, with access rules dynamically applied to specific actions. Responsive tab patterns are used platform-wide, displaying icons only on mobile and icons with text on desktop. Dashboard titles appear only in `DashboardNavbar.tsx` to prevent duplication, and module icons retain their distinct original colors.
- **Technical Implementations**:
    - **Frontend**: React (TypeScript) with Wouter for routing, TanStack Query for data fetching, and PWA capabilities.
    - **Backend**: RESTful API built on Express.js.
    - **Database & ORM**: PostgreSQL on Neon Serverless, managed with Drizzle ORM.
    - **Authentication**: Session-based using `express-session` and `Passport.js`, including Firebase Google OAuth. Supports 8-role-based access control with multi-role capabilities, prioritizing phone numbers as primary unique identifiers (email optional).
    - **Route Architecture**: Express.js routes are prioritized, with internal routes registered before external routers. Module mappings are strictly segmented per dashboard.
    - **Cache Management**: `queryClient.ts` uses `serializeQueryKey()` to prevent query key collisions, ensuring immediate data display and efficient cache invalidation.
    - **Document Management**: Centralized system for instant PDF generation via `server/services/pdfGenerator.ts`. Documents are stored in `/public/documents/` in lowercase kebab-case. Homework attachments are supported with dedicated upload endpoints and JSONB storage.
    - **Bulletin Generation**: Bulletins are generated using an adaptive flexbox layout in `client/src/index.css`, optimized for print and `html2canvas` for PDF capture. School logos are dynamically fetched from `/api/director/settings` using `school.logoUrl` or `profile.logoUrl`.
- **Feature Specifications**: Includes real-time attendance tracking (Present, Late, Absent), flexible timetable management, multi-channel notifications (Email, WhatsApp, PWA), comprehensive bilingual templates, integrated payment systems, iCal/ICS export, and robust bulk Excel import with immediate data display. Supports Competency-Based Approach (CBA) bulletin generation and integrates Jitsi Meet for online classes. Schools can define custom academic levels via API and UI. Online course access rules are dynamically managed by subscription type. Parent subscriptions are configurable by Site Admins via `school_parent_pricing`, including automatic family discounts. Student messaging is restricted to parents for sending but allows receiving from all profiles. Automated homework creation and submission notifications include timely reminders. The student-parent connection workflow involves student requests, parent approval/rejection, and status tracking in `parent_student_relations`.
- **System Design Choices**: All storage modules exclusively use Drizzle ORM for database queries, enforcing multi-tenancy with `user.schoolId` and eliminating hardcoded/mock data. Sandbox data is pre-seeded with idempotent scripts. User management includes a multi-role system (`role_affiliations`) and detects existing users by email/phone. Development and production databases are entirely separated. "Contact Educafric" buttons consistently open WhatsApp with a pre-filled message using the official number `237656200472`. Bulk import of teachers uses a default password `Educafric2024!` with explicit `Teacher` role assignment and `ON CONFLICT DO NOTHING` for deduplication. The Director's Geolocation Management module has been removed. The `enrollments` table is the sole source for student class registrations. The `parent_student_relations` table manages parent-student linkages. Parent API responses return objects containing data, not direct arrays. The Android mobile app restricts access for Commercial, SiteAdmin, and Admin profiles.

# External Dependencies
- **Neon Database**: Serverless PostgreSQL database.
- **Stripe**: Payment gateway.
- **Firebase**: Google OAuth authentication.
- **WhatsApp**: Direct API integration for notifications.
- **Hostinger**: SMTP services for email notifications.
- **Jitsi Meet**: Video conferencing for online classes.